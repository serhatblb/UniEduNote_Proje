{% extends "notes/base.html" %}
{% load static %} {% block title %}{{ note.title }} Detay{% endblock %}

{% block content %}
<style>
  body{background:#f4f6fa;}
  /* NOT: Sidebar CSS'i base.html'den gelmeli, ama burada bıraktım. */
  .layout{display:flex;min-height:100vh;}
  .sidebar{
    width:240px;background:linear-gradient(180deg,#00205B,#001540);
    color:#fff;display:flex;flex-direction:column;justify-content:space-between;
    padding:1.5rem 1rem;position:fixed;left:0;top:0;bottom:0;transition:transform .3s;
  }
  /* ... (Geri kalan tüm Sidebar ve genel CSS kodları aynı kalıyor) ... */

  /* === CARD === */
  .detail-card{
    background:#fff;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.07);
    padding:2rem;max-width:800px;margin:auto;
  }
  h1{color:#00205B;font-weight:700;margin-bottom:1rem;}
  .badges span{
    display:inline-block;background:#f3f4f6;color:#374151;font-size:.85rem;
    padding:.4rem .7rem;border-radius:8px;margin:.2rem;
  }
  .desc{font-size:1.05rem;line-height:1.6;color:#374151;margin-top:1rem;}
  hr{margin:2rem 0;border-top:1px solid #e5e7eb;}
  .meta{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
  .meta small{color:#6b7280;}
  .btn-download{background:#10B981;color:#fff;border:none;padding:.6rem 1rem;
    border-radius:8px;font-weight:600; cursor:pointer;} /* Cursor eklendi */
  .btn-download:hover{background:#0e906f;}
  .back-links{margin-top:1.5rem;display:flex;gap:.6rem;flex-wrap:wrap;}
  .btn-back{background:#00205B;color:#fff;padding:.5rem 1rem;border-radius:8px;text-decoration:none;}
  .btn-back:hover{background:#001b4a;}
  .btn-secondary{border:1px solid #d1d5db;color:#374151;text-decoration:none;
    padding:.5rem 1rem;border-radius:8px;}
  .btn-secondary:hover{background:#f3f4f6;}
</style>

<button class="toggle-btn" id="toggleSidebar">☰</button>

{% csrf_token %}

<div class="layout">
  <div class="sidebar" id="sidebar">
    <div>
      <h3>📚 UniEduNote</h3>
      <a href="{% url 'dashboard' %}">🏠 Ana Sayfa</a>
      <a href="{% url 'note_list' %}" class="active">🔍 Notları Keşfet</a>
      <a href="{% url 'upload_note' %}">⬆️ Not Yükle</a>
    </div>
    <div class="sidebar-footer"><small>© 2025 UniEduNote</small></div>
  </div>

  <div class="main-content">
    <div class="detail-card">
      <h1>{{ note.title }}</h1>
      <div class="badges">
        <span>{{ note.course.code }} - {{ note.course.name }}</span>
        <span>{{ note.course.semester.department.university.name }}</span>
        <span>{{ note.course.semester.department.name }}</span>
          <span class="badge bg-success">
            ⬇️ <span class="download-counter-{{ note.pk }}">{{ note.download_count }}</span> İndirme
          </span>
      </div>

      <p class="desc">{{ note.description }}</p>

      <hr>
      <div class="meta">
        <div>
          <small>👤 Yükleyen: <b>{{ note.uploader.username }}</b></small><br>
          <small>📅 Tarih: {{ note.upload_date|date:"d M Y" }}</small>
        </div>

        <div class="d-flex gap-2">
            {% if note.uploader == request.user %}
                <a href="{% url 'edit_note' pk=note.pk %}" class="btn btn-warning">Düzenle</a>
                <a href="{% url 'delete_note' pk=note.pk %}" class="btn btn-danger">Sil</a>
            {% endif %}

            <a href="#" class="btn-download" id="detail-download-btn" data-pk="{{ note.pk }}">
                <i class="fas fa-download me-2"></i> Dosyayı İndir
            </a>
        </div>
      </div>

      <div class="back-links">
        <a href="{% url 'note_list' %}" class="btn-back">← Tüm Notlara Dön</a>
        <a href="{% url 'dashboard' %}" class="btn-secondary">🏠 Ana Sayfa</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sidebar Toggle Kodu
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => sidebar.classList.toggle('show'));
        }

        // AJAX/İndirme Kodu Başlangıcı
        const downloadButton = document.getElementById('detail-download-btn');

        if (downloadButton) {
            downloadButton.addEventListener('click', function(e) {
                e.preventDefault();

                {% if not user.is_authenticated %}
                    alert("İndirme işlemi için lütfen önce giriş yapınız.");
                    window.location.href = "{% url 'login' %}";
                    return;
                {% endif %}

                const noteId = this.dataset.pk;

                // 1. AJAX: Sayacı artır
                updateCount(noteId).then(response => {
                    if (response.success) {
                        // 2. Sayfa üzerindeki sayacı anında güncelle
                        const counterElement = document.querySelector(`.download-counter-${noteId}`);
                        if (counterElement) {
                            counterElement.textContent = response.new_count;
                        }

                        // 3. Dosyayı indir
                        downloadFile(noteId);
                    } else {
                        console.error('Sayaç güncellenemedi:', response.error);
                        downloadFile(noteId);
                    }
                }).catch(error => {
                    console.error('AJAX/Ağ hatası:', error);
                    downloadFile(noteId);
                });
            });
        }

        // --- Ortak Fonksiyonlar ---

        function updateCount(noteId) {
            const url = `{% url 'update_download_count' pk=0 %}`.replace('0', noteId);
            // CSRF token'ı çekmek için input[name=csrfmiddlewaretoken] kullanıyoruz
            const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

            return fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken,
                },
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            });
        }

        // Dosya indirme fonksiyonu (Dosyayı indirir)
        function downloadFile(noteId) {
            const fileUrl = `{% url 'download_file_only' pk=0 %}`.replace('0', noteId);
            window.location.href = fileUrl; // Bu indirmeyi tetikleyen satır
        }
    });
</script>
{% endblock scripts %}