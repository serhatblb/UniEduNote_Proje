{% extends "notes/base.html" %}
{% load static %}  {% block title %}Notlarƒ± Ke≈üfet{% endblock %}

{% block head %}
<style>
  /* CSS'leri buraya ta≈üƒ±dƒ±m */
  .page-container { max-width:1280px!important; width:100%!important; }
</style>
{% endblock %}

{% block content %}
<style>
  /* === Genel CSS === */
  body { background:#f4f6fa; }

  /* === √úST Fƒ∞LTRE ALANI === */
  .filter-section {
    background:#fff;
    border-radius:20px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    padding:2rem;
    margin-bottom:2rem;
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  .filter-section h3 {
    font-weight:700;
    color:#00205B;
    margin-bottom:.5rem;
  }
  .filter-form {
    display:flex;
    flex-wrap:wrap;
    gap:1rem;
    align-items:flex-end;
  }
  .filter-form label {
    font-weight:600;
    color:#00205B;
    margin-bottom:.3rem;
    font-size:.9rem;
  }
  .filter-form select,
  .filter-form input {
    padding:.5rem .75rem;
    border:1px solid #d1d5db;
    border-radius:8px;
    min-width:180px;
    font-size:.9rem;
  }
  .filter-form button {
    background:#00205B;
    color:#fff;
    border:none;
    padding:.6rem 1.2rem;
    border-radius:8px;
    font-weight:600;
  }
  @media(max-width:768px){
    .filter-form{ flex-direction:column; align-items:stretch; }
    .filter-form select, .filter-form input{ width:100%; }
  }

  /* === ALT NOTLAR GRID === */
  .notes-section {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
    gap:1.5rem;
  }
  .note-card {
    background:#fff;
    border-radius:16px;
    padding:1.25rem;
    box-shadow:0 4px 15px rgba(0,0,0,0.07);
    transition:transform .2s, box-shadow .2s;
    cursor:pointer;
  }
  .note-card:hover {
    transform:translateY(-5px);
    box-shadow:0 8px 22px rgba(0,0,0,0.12);
  }
  .note-title { font-size:1.1rem;font-weight:600;color:#00205B;margin-bottom:.4rem; }
  .note-desc { font-size:.9rem;color:#6b7280;margin-bottom:.8rem;min-height:2.2rem; }
  .note-meta { display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.8rem; }
  .note-meta span {
    background:#f3f4f6;
    color:#374151;
    padding:.3rem .6rem;
    border-radius:6px;
    font-size:.8rem;
  }
  .note-footer { display:flex;justify-content:space-between;align-items:center; }
  .note-footer small { color:#6b7280; }
  .btn-download {
    background:#10B981;
    color:#fff;
    border:none;
    padding:.4rem .9rem;
    border-radius:8px;
    font-size:.85rem;
    text-decoration:none;
    cursor:pointer; /* AJAX butonu olduƒüunu belirtir */
  }
  .empty-state { text-align:center;padding:3rem 1rem;color:#6b7280; }
</style>

<div class="filter-section">
  <h3>üéì Notlarƒ± Filtrele</h3>
  <form method="GET" id="filter-form" class="filter-form">
    <div>
      <label for="filter_university">√úniversite</label>
      {{ filter_form.university }}
    </div>
    <div>
      <label for="filter_department">B√∂l√ºm</label>
      {{ filter_form.department }}
    </div>
    <div>
      <label for="filter_semester">D√∂nem</label>
      {{ filter_form.semester }}
    </div>
    <div>
      <label for="q">Arama</label>
      <input type="text" name="q" id="q" placeholder="Ders, ba≈ülƒ±k..." value="{{ current_search_query }}">
    </div>
    <div><button type="submit">Filtrele</button></div>
  </form>
</div>

{% if notes %}
<div class="notes-section">
  {% for note in notes %}
  <div class="note-card">
    <div onclick="window.location.href='{% url 'note_detail' note.id %}'" style="cursor:pointer; padding-bottom:1rem;">
        <div class="note-title">{{ note.title }}</div>
        <div class="note-desc">{{ note.description|truncatechars:90 }}</div>
        <div class="note-meta">
          <span>{{ note.course.code }}</span>
          <span>{{ note.course.name }}</span>
          <span>{{ note.course.semester.department.university.name }}</span>
          <span>{{ note.course.semester.department.name }}</span>
        </div>
    </div>

    <div class="note-footer">
      <small>
        {{ note.uploader.username }} ‚Ä¢ {{ note.upload_date|date:"d M Y" }}
        ‚¨áÔ∏è <span class="download-counter-{{ note.pk }}">{{ note.download_count }}</span> ƒ∞ndirme
      </small>

      <a href="#" class="btn-download" data-pk="{{ note.pk }}">ƒ∞ndir</a>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <h4>Hen√ºz hi√ß not y√ºklenmedi</h4>
  <p>Filtreleri sƒ±fƒ±rlayabilir veya yeni not y√ºkleyebilirsin.</p>
  <a href="{% url 'upload_note' %}" class="btn btn-primary mt-2">Not Y√ºkle</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const downloadButtons = document.querySelectorAll('.btn-download');

        downloadButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Varsayƒ±lan link davranƒ±≈üƒ±nƒ± durdur

                // Eƒüer kullanƒ±cƒ± giri≈ü yapmadƒ±ysa login'e y√∂nlendir
                {% if not user.is_authenticated %}
                    alert("ƒ∞ndirme i≈ülemi i√ßin l√ºtfen √∂nce giri≈ü yapƒ±nƒ±z.");
                    window.location.href = "{% url 'login' %}";
                    return;
                {% endif %}

                const noteId = this.dataset.pk;

                // 1. AJAX: Sayacƒ± artƒ±r
                updateCount(noteId).then(response => {
                    if (response.success) {
                        // 2. Sayfa √ºzerindeki sayacƒ± anƒ±nda g√ºncelle
                        const counterElement = document.querySelector(`.download-counter-${noteId}`);
                        if (counterElement) {
                            // Sadece sayƒ±yƒ± g√ºncellemek i√ßin textContent kullandƒ±k
                            counterElement.textContent = response.new_count;
                        }

                        // 3. Dosyayƒ± indir
                        downloadFile(noteId);
                    } else {
                        console.error('Saya√ß g√ºncellenemedi:', response.error);
                        downloadFile(noteId);
                    }
                }).catch(error => {
                    console.error('AJAX/Aƒü hatasƒ±:', error);
                    downloadFile(noteId);
                });
            });
        });

        // AJAX fonksiyonu (Sayacƒ± g√ºnceller)
        function updateCount(noteId) {
            // Django URL'lerini JS i√ßinde kullanmak i√ßin trick
            const url = `{% url 'update_download_count' pk=0 %}`.replace('0', noteId);
            // Ana ≈üablonda olmasƒ± gereken CSRF token'ƒ± √ßeker
            const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

            return fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', // Django'ya AJAX olduƒüunu bildirir
                    'X-CSRFToken': csrftoken,
                },
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            });
        }

        // Dosya indirme fonksiyonu (Dosyayƒ± indirir)
        function downloadFile(noteId) {
    const fileUrl = `{% url 'download_file_only' pk=0 %}`.replace('0', noteId);
    window.location.href = fileUrl; // Bu indirmeyi tetikleyen satƒ±r
}
    });
</script>
{% endblock scripts %}