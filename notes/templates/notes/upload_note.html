{% extends "notes/base.html" %}
{% block title %}
  {% if is_editing %}Notu Düzenle{% else %}Yeni Not Yükle{% endif %}
{% endblock %}

{% block content %}
<style>
  .page-wrap{min-height:calc(100vh - 120px);}
  .card{border:0;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.07);}
  .card-body{padding:1.5rem 1.75rem;}
  .section-title{font-size:1rem;margin:.25rem 0 .75rem 0;color:#00205B;font-weight:600;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  @media(max-width:992px){.form-grid{grid-template-columns:1fr;}}
  form select,form textarea,form input[type="text"],form input[type="file"]{
    width:100%;padding:.65rem .75rem;border:1px solid #d1d5db;border-radius:8px;
    background:#fff;font-size:.95rem;
  }
  form textarea{min-height:96px;max-height:140px;}
  .btn-lg{
    padding:.6rem 1.25rem;font-size:1rem;border-radius:.6rem;
    background:#00205B;border:none;color:#fff;font-weight:600;
  }
  .btn-lg:hover{background:#001b4a;}
  .btn-secondary{border:none;background:#6c757d;color:#fff;}
  .btn-secondary:hover{background:#5c636a;}
  .sticky-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;}
</style>

<div class="container page-wrap d-flex justify-content-center align-items-start py-4">
  <div class="col-xl-8 col-lg-9">
    <h2 class="mb-3 fw-semibold text-primary">
      {% if is_editing %}
        "{{ note.title }}" Notunu Düzenle
      {% else %}
        Yeni Not Yükle
      {% endif %}
    </h2>

    <div class="card">
      <div class="card-body">
        <form method="POST" enctype="multipart/form-data"
          action="{% if is_editing %}{% url 'edit_note' pk=note.pk %}{% else %}{% url 'upload_note' %}{% endif %}">
          {% csrf_token %}

          <div class="section-title">1️⃣ Notun Yerini Seçin</div>
          <div class="form-grid">
            <div>
              <label for="{{ form.university.id_for_label }}" class="form-label fw-semibold">
                {{ form.university.label }}
              </label>
              {{ form.university }}
            </div>
            <div>
              <label for="{{ form.department.id_for_label }}" class="form-label fw-semibold">
                {{ form.department.label }}
              </label>
              {{ form.department }}
            </div>
            <div>
              <label for="{{ form.semester.id_for_label }}" class="form-label fw-semibold">
                {{ form.semester.label }}
              </label>
              {{ form.semester }}
            </div>
            <div>
              <label for="{{ form.course.id_for_label }}" class="form-label fw-semibold">
                {{ form.course.label }}
              </label>
              {{ form.course }}
            </div>
          </div>

          <div class="section-title mt-3">2️⃣ Not Bilgilerini Girin</div>
          <div class="form-grid">
            <div style="grid-column:1/-1">
              <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">
                {{ form.title.label }}
              </label>
              {{ form.title }}
            </div>

            <div style="grid-column:1/-1">
              <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">
                {{ form.description.label }}
              </label>
              {{ form.description }}
            </div>

            <div style="grid-column:1/-1">
              <label for="{{ form.file.id_for_label }}" class="form-label fw-semibold">
                {{ form.file.label }}
              </label>
              {% if is_editing %}
                <p class="text-muted small mb-2">
                  Mevcut dosya:
                  <a href="{{ note.file.url }}" target="_blank">{{ note.file.name|slice:"15:" }}...</a><br>
                  Yeni dosya yüklerseniz eskisinin üzerine yazılacaktır.
                </p>
              {% endif %}
              {{ form.file }}
              <div class="form-text">PDF önerilir. Maks. 25 MB.</div>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="alert alert-danger mt-3 mb-0">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="sticky-actions">
            <a href="{% if is_editing %}{% url 'note_detail' pk=note.pk %}{% else %}{% url 'dashboard' %}{% endif %}" class="btn btn-secondary btn-lg">
              İptal
            </a>
            <button type="submit" class="btn btn-lg">
              {% if is_editing %}Güncelle{% else %}Notu Yükle{% endif %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {
      $("#id_university").change(function () {
          var universityId = $(this).val();
          if (universityId) {
              $.ajax({
                  url: "{% url 'ajax_load_departments' %}",
                  data: { 'university_id': universityId },
                  dataType: 'json',
                  success: function (data) {
                      $("#id_department").empty().append('<option value="">--- Bölüm Seçin ---</option>');
                      $("#id_semester").empty().append('<option value="">--- Dönem Seçin ---</option>');
                      $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
                      $.each(data, function (key, value) {
                          $("#id_department").append('<option value="' + value.id + '">' + value.name + '</option>');
                      });
                  }
              });
          } else {
              $("#id_department").empty().append('<option value="">--- Bölüm Seçin ---</option>');
              $("#id_semester").empty().append('<option value="">--- Dönem Seçin ---</option>');
              $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
          }
      });

      $("#id_department").change(function () {
          var departmentId = $(this).val();
          if (departmentId) {
              $.ajax({
                  url: "{% url 'ajax_load_semesters' %}",
                  data: { 'department_id': departmentId },
                  dataType: 'json',
                  success: function (data) {
                      $("#id_semester").empty().append('<option value="">--- Dönem Seçin ---</option>');
                      $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
                      $.each(data, function (key, value) {
                          $("#id_semester").append('<option value="' + value.id + '">' + value.name + '</option>');
                      });
                  }
              });
          } else {
              $("#id_semester").empty().append('<option value="">--- Dönem Seçin ---</option>');
              $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
          }
      });

      $("#id_semester").change(function () {
          var semesterId = $(this).val();
          if (semesterId) {
              $.ajax({
                  url: "{% url 'ajax_load_courses' %}",
                  data: { 'semester_id': semesterId },
                  dataType: 'json',
                  success: function (data) {
                      $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
                      $.each(data, function (key, value) {
                          $("#id_course").append('<option value="' + value.id + '">' + value.name + '</option>');
                      });
                  }
              });
          } else {
              $("#id_course").empty().append('<option value="">--- Ders Seçin ---</option>');
          }
      });
  });
</script>
{% endblock %}
